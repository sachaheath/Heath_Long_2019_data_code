<<<<<<< HEAD
---
title: "Heath, S.K. and R.F. Long. 2019. Multiscale habitat mediates pest reduction by birds in an intensive agricultural region. Ecosphere. DOI: 10.1002/ecs2.2884"
sub-title: "Bird community analyses, tables, and figures"
author: "Sacha K. Heath"
date: "started August 2017; code edited for publication August 2019"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

```{r, include = FALSE}
knitr::opts_chunk$set(comment = NA)
```

Required packages

```{r}
library(plyr)
library(tidyr)
library(dplyr)
library(data.table)
library(reshape)

library(vegan)
library(ape)
library(rethinking)

library(ggplot2)
library(ggrepel)
library(gtable) # for changing the legend letters from a to something else
library(scales)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(grid)
library(cowplot)
```

Colors I like that are also ok for color-blindness
```{r, fig.height=3, fig.width=14}
skhpal<-c("black","gray25","gray75", "slateblue","darkslateblue", "royalblue4", "chartreuse3","forestgreen", "darkgreen","chocolate3","darkgoldenrod1", "darkgoldenrod3", "#fed976","#feb24c","#fd8d3c", "#fc4e2a", "#e31a1c","#b10026")

plot(x = 1:length(skhpal), y = rep(1, length(skhpal)), pch = 19, cex = 5, 
    col = skhpal, yaxt = "n", bty = "n", xaxt = "n", xlab = "", ylab = "")
text(x = 1:length(skhpal), y = rep(1, length(skhpal), labels = seq(1:length(skhpal))))
```


Code presented in order of when it is referred to in the text

**Appendix S2: Table S1**

```{r}
all<-read.csv("./bird_data/all_spp.csv")  # all bird species detected at all distances, margins and interiors
mbo<-read.csv("./bird_data/marginbirds_20m_n20.csv")  # birds detected in 20x300 margin transects
ibo<-read.csv("./bird_data/intbirds_20m_n20.csv")   # birds detected in 20x300 interior transects
ibo2<-read.csv("./bird_data/intbirds_200m_n20.csv") # birds detected in 200x300 interior transects

m<-as.data.frame(names(mbo %>% select(AMCR:PUFI) %>% droplevels())); names(m)[1]<-c("spec")
i<-as.data.frame(names(ibo %>% select(AMCR:YRWA) %>% droplevels())); names(i)[1]<-c("spec")
i2 <-as.data.frame(names(ibo2 %>% select(AMCR:YRWA) %>% droplevels())); names(i2)[1]<-c("spec")
m$m<-1
i$i<-1
i2$i2<-1

transect_speclist<-Reduce(function(x, y) merge(x, y, all=TRUE), list(all, m,i,i2))
transect_speclist
```


**Likely predator categorization by foraging traits**

I used a systematic process to assign diet guilds, foraging site substrates, and attack types for all birds I observed during counts.

Dietary guild  
Foraging Site Substrate  
Attack Behavior  

For non-breeding season/year round dietary guilds, I followed the methodologies of [Kissling et al. (2011)](http://bit.ly/2k1YCjR)
For each species, the dietary components mentioned in the literature were assigned to seven categories. Each category was ranked in importance  for each individual species when it was present as a dietary component *(in winter for this study)*, based on the Birds of North America online species accounts for each species, and/or other sources if necessary. Diet ranks of a species add up to a score of 10, and from this assignment we classified species into dietary guilds based on their primary (i.e. predominant) diet and foraging type (score > 5). This classification characterizes the dominant diet type of a species.All remaining species with diet ranks < 5 (e.g. fruit 5, insect 2, nectar 2, seed 1) were classified as omnivores)

Foreaging substrate definition: the place where a food item is found or taken (DeGraff et al. 1985). To assign non-breeding season/year round Foraging Site Substrate type to our birds, we followed the terminology of [Remsen and Robinson (1990)](http://bit.ly/2xwxvmg) and the classification system of [De Graff et al. 1985](http://bit.ly/2xEF0qI), using BNA as source material as well. 

Attack behavior definition: Foraging technique, refers to the manner in which food is obtained (some associated with particular food types or substrates). To assign non-breeding season/year round Attack Behavior type to our birds, I followed the terminology of [Remsen and Robinson (1990)](http://bit.ly/2xwxvmg) and the classification system of [De Graff et al. 1985](http://bit.ly/2xEF0qI), using BNA as source material as well.

In addition to the above rankings and sources, I further researched for evidence of *C. pomomella* consumption by birds in the literature, as well of evidence outside of [De Graff et al. 1985](http://bit.ly/2xEF0qI) that a species utilizes bark or tree trunks as foraging substrate *while also* using pecking, probing, or flaking attack modes. I researched these criteria for every species detected in our study via liteture searches (sources: Beal 1910, McAtee 1912 {alone and in reference to Melander and Jenne 1906}, Holmes et al. 1979, BNAO, and Ehrlich et al. 1980). We also confirmed species video during the study.

```{r}
lp<-read.csv("./bird_data/likelypredators.csv")    # likely predator species
lp
```



**Figure 2: Absolute maximum abundance heat map of avian predators of C. pomonella in orchard margin and interior strip-transects (20m Ã— 300m). **

```{r}
#Heatmap of relative abundances between sites by [Umer Zeeshan Ijaz] [http://userweb.eng.gla.ac.uk/umer.ijaz]

df<-read.csv("./bird_data/abs_abundance_heatmap.csv") #Maximum abundance (across 3 visits) of likely predators
df$site<-as.factor(df$site)
```

```{r, fig.width=6, fig.height=7, warning =FALSE}
lpred_MA_heatmap<-
  ggplot(df, aes(site, Species)) + 
  geom_tile(aes(fill = MA), col = "white") + #this color outlines the tiles
  scale_fill_gradientn(name="                       ", 
                       colours=c("white",      "#fed976", "#fed976",     "#fd8d3c","#fd8d3c",  #colorblind friendly
                                 "#fc4e2a","#fc4e2a","#fc4e2a",        "#b10026"), 
                       values=rescale(c(0,      1,                       2, 3, 
                                 4, 5, 6,                                13)),
                       breaks=c(0,1.25,3,6,13),labels=c(0,"1","2-3","4-6","13"),limits=c(0,13)) + 
  scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) +
  #coord_fixed(ratio=1) +
  facet_wrap(~trantype , ncol = 1, scales = "free", switch="x") +
  theme_classic() +
  theme(axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size=14, color = "black"),
        strip.background = element_blank(), strip.text = element_text(size = 20), 
        strip.placement = "outside",
        panel.spacing = unit(0.5, "cm"),
        legend.position = "top", 
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        legend.key.width = unit(1, "cm"),legend.key.height = unit(0.50, "cm"),
        plot.margin=unit(c(0.5,0.5,0.5,0.5),"mm"))

lpred_MA_heatmap
```


```{r}
tiff("Figure2.tiff", width = 6, height = 6, units = 'in',res=600)
lpred_MA_heatmap
grid.text("Maximum abundance", x = unit(6.5, "cm"), y = unit(14.75, "cm"), gp=gpar(fontsize=18))
dev.off()

cairo_pdf(file = "Figure2.pdf", width=6, height=6) #embeds fonts
lpred_MA_heatmap
grid.text("Maximum abundance", x = unit(6.5, "cm"), y = unit(14.75, "cm"), gp=gpar(fontsize=18))
dev.off()
```

Maximum abundance summaries
```{r}
mbo<-read.csv("./bird_data/marginbirds_20m_n20.csv")  # birds detected in 20x300 margin transects

mbo %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))

ibo<-read.csv("./bird_data/intbirds_20m_n20.csv")   # birds detected in 20x300 interior transects
ibo %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))
```

**Analyses: Rarefied Richness and Abundance; 20m x 300m margin transects**

```{r}
mbv <-read.csv("./bird_data/marginbirds_20m_n60.csv")  #20 x 300m margin detections by orchards and visits, n = 60
lp<-read.csv("./bird_data/likelypredators.csv")  

Reduce(intersect, list(names(mbv),lp$spec)) #which likely predators are in the margin database?

lpmv<-mbv %>%
  dplyr::select(orchard, edgegen, visit, NOFL, YBMA, BEWR, BUSH, NUWO, RBSA, ACWO, HETH, OATI, WBNU) #likely predator species only

#likeley predators in clean margins
lpcm<- lpmv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="control") %>%
       ungroup() %>%
       dplyr::select(NOFL:WBNU)  %>%
       droplevels()

# Compute individual- and sample- based rarefaction curve via boostrap. rarc() performs rarefaction using resampling with replacement.
# Bootstrap estimation based on 999 randomizations
lpmc<-rarc(lpcm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmc$out #curve estimates
rarc_lpcm<-as.data.frame(lpmc$out) #curve estimates
lpmc$bootstrapped.val #raw bootstrapped values
(sd(lpmc$bootstrapped.val[[3]][,1])) #Compute the standard deviation, instead of the quantiles, for the final (10th) sampling


#likeley predators habitat margins
lphm<- lpmv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="habitat") %>%
       ungroup() %>%
       dplyr::select(NOFL:WBNU)  %>%
       droplevels()

lpmh<-rarc(lphm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmh$out
rarc_lphm<-as.data.frame(lpmh$out)
lpmh$bootstrapped.val
(sd(lpmh$bootstrapped.val[[3]][,1]))
```

**Appendix S2: Figure S1 A**

```{r, fig.width =7, fig.height=7 , eval=FALSE, echo=FALSE}
lpp<-read.csv("./bird_data/likepred_SR_MARG_bootplot.csv")

FIGboot_likepred_samplerich<-
  ggplot(lpp, aes(x=sample, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = sample, ymin=lo, ymax=hi), width=0,lwd = 0.5, col="black") +
  geom_point(aes(fill=margintype), pch= 21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8])) +
  scale_x_continuous(name = "Orchard-visit samples",limits = c(0,35), expand = c(0, 0), 
                    breaks = c(0,6,12,18,24,30)) +
  scale_y_continuous(name = "Rarefied predator richness", limits = c(0,11), expand = c(0, 0.25)) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_text(size=22, colour="black"), 
        axis.title.y = element_text(size=28, margin = unit(c(0, 5, 0, 0), "mm")),
        axis.ticks.length = unit(3,"mm"),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm")))+
  theme(legend.position="none")
FIGboot_likepred_samplerich 
```


**Appendix S2: Figure S1 B**

```{r, fig.width =7, fig.height=7,warnign=FALSE}
lpp<-read.csv("./bird_data/likepred_SR_MARG_bootplot.csv")
lpp_habitat<-filter(lpp, margintype=="habitat")
lpp_clean<-filter(lpp, margintype=="clean")

#To help plot the low number of detections in clean margins
p <-
  ggplot(NULL, aes(x=0:95, y=0,11)) +
  geom_line(data = lpp_habitat, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_line(data = lpp_clean, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_errorbar(data = lpp_habitat, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="black") +
  geom_errorbar(data = lpp_clean, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="gray40") + 
  geom_point(data = lpp_habitat, aes(x=indiv, y=cum.rich), size=7, shape=21, fill=skhpal[8]) +
  geom_point(data = lpp_clean, aes(x=indiv, y=cum.rich), size=2, shape=21, fill=skhpal[10]) + 
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,11), expand = c(0, 0.25)) 

# Got this hack from [here][https://stackoverflow.com/questions/16389636/in-ggplot2-how-can-i-add-additional-legend]
a= 94
b= rep(c(20), 20)
f = 1:20 
factor=c("Clean","Habitat")
abf = data.frame(a,b,f, factor)

FIGboot_likepred_indivrich <-
  ggplot(NULL, aes(x=0:95, y=0,11)) +
  geom_line(data = lpp_habitat, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_line(data = lpp_clean, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_errorbar(data = lpp_habitat, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="black") +
  geom_errorbar(data = lpp_clean, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="gray40") + 
  geom_point(data = lpp_habitat, aes(x=indiv, y=cum.rich), size=7, shape=21, fill=skhpal[8]) +
  geom_point(data = lpp_clean, aes(x=indiv, y=cum.rich), size=2, shape=21, fill=skhpal[10]) + 
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,11), expand = c(0, 0.25))  +
  geom_point(data = abf, aes(x=a, y=f,fill=factor), color="white") + # hack
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm"))) +
  theme(legend.position=c(0.80, 0.20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18)) +
  guides(fill = guide_legend(title = "Margin type",
                            override.aes = list(shape=21, size = 8, color="black",
                            fill = c(skhpal[10],skhpal[8]))))
FIGboot_likepred_indivrich
```

Combine plots and print
```{r, fig.width =14, fig.height=7, warning=FALSE, echo=FALSE, eval=FALSE}
FIG.likepred_bootRich_combined<-
  plot_grid(FIGboot_likepred_samplerich,FIGboot_likepred_indivrich, 
            align='h', axis='b', 
            rel_widths = c(1.10, 1), 
            labels=c('A', 'B'), label_size = 24, label_fontface ="plain", label_x = c(0.16,0.09))

FIG.likepred_bootRich_combined 
```

Export combined plot 
```{r export FIG.likepred_bootRich_combined, echo=FALSE, eval=FALSE}
tiff("FIG.likepred_bootRich_combined.tif", width=14, height=7, units ='in',res=1000)
FIG.likepred_bootRich_combined
dev.off()

cairo_pdf(file = "FIG.likepred_bootRich_combined.pdf", width=14, height=7) #embeds fonts
FIG.likepred_bootRich_combined
dev.off()
```


**Analyses: Bray-Curtis Dissimilarity Index for 20m x 300m margin and interior transects**

```{r}
lpreds <- read.csv("./bird_data/lpred.matrix.csv") # Likely predators maximum abundance for 20m x 300m margin and interior transects
lpred.matrix <- as.matrix(sapply(lpreds[2:11], as.numeric))
rownames(lpred.matrix)<-(lpreds)[,1]
lpred_M.diss.I_bray<-vegdist(lpred.matrix, method = "bray")
lpred_M.diss.I_bray
```



**Analyses: NMDS and Permutational Multivariate Analysis of Variance Using Distance Matrices, for 20m x 300m margin and interior transects**

```{r}
lpreds <- read.csv("./bird_data/lpred.matrix.csv") # Likely predators maximum abundance for 20m x 300m margin and interior transects
lpred.matrix <- as.matrix(sapply(lpreds[2:11], as.numeric))
rownames(lpred.matrix)<-(lpreds)[,1]


lp_NMDS = metaMDS(lpred.matrix,          # community matrix
                  distance = "bray", # type of dissimilarity to calculate
                  k = 2,             # reduce to 2 dimensions
                  #trymax = 100,      # max number of random starts (increase if no stable converge)
                  #noshare	= 0.1,     # Prop. site pairs with no shared species to trigger stepacross 
                  wascores = TRUE)   #	Calculate weighted average species scores 
                     
lpreds.sq <- sqrt(lpred.matrix)
lp.sq_NMDS = metaMDS(lpreds.sq,          # community matrix
                  distance = "bray", # type of dissimilarity to calculate
                  k = 2,             # reduce to 2 dimensions
                  #trymax = 100,      # max number of random starts (increase if no stable converge)
                  #noshare	= 0.1,     # Prop. site pairs with no shared species to trigger stepacross 
                  wascores = TRUE)   #	Calculate weight


lp_NMDS; lp.sq_NMDS

lp_NMDS$stress
stressplot(lp_NMDS)
stressplot(lp.sq_NMDS)
plot(lp_NMDS)
plot(lp.sq_NMDS)

####

lpsite <- read.csv("./bird_data/lpred.site.data.matrix.csv")
lp.site_data <- as.matrix(sapply(lpsite[2:7], as.numeric))
rownames(lp.site_data)<-(lpsite)[,1]

trantype<-as.factor(lp.site_data[,2])
pair<-as.factor(lp.site_data[,5])
margtype<-as.factor(lp.site_data[,3])
orchard<-as.factor(lp.site_data[,1])

multi.anova<-adonis(lpred.matrix ~ trantype + margtype + trantype*margtype, strata=orchard, perm=999)
multi.anova
```


**Analyses: Rarefied Richness; 200m x 300m interior transects**

```{r}
ibv <-read.csv("./bird_data/intbirds_200m_n60.csv")  # 200m x 300m interior birds by orchards and visits
lp<-read.csv("./bird_data/likelypredators.csv")  

Reduce(intersect, list(names(ibv),lp$spec)) #which likely predators are in the interior database?

lpiv<-ibv %>%
  dplyr::select(orchard, edgegen, visit, HETH, NOFL, NUWO, OATI, WBNU, YBMA) 

# likely predators in orchard interiors with clean margins
lpci<- lpiv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="control") %>%
       ungroup() %>%
       dplyr::select(HETH:YBMA)  %>%
       droplevels()

# Compute individual- and sample- based rarefaction curve via boostrap. rarc() performs rarefaction using resampling with replacement.
# Bootstrap estimation based on 999 randomizations
lpic<-rarc(lpci, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpic$out #curve estimates
lpic$bootstrapped.val #raw bootstrapped values
(sd(lpic$bootstrapped.val[[3]][,1]))

lpmc<-rarc(lpcm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmc$out #curve estimates
lpmc$bootstrapped.val #raw bootstrapped values
(sd(lpmc$bootstrapped.val[[3]][,1])) #Compute the standard deviation, instead of the quantiles, for the final (10th) sampling


# likely predators in orchard interiors with habitat margins
lphi<- lpiv  %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="habitat") %>%
       ungroup() %>%
       dplyr::select(HETH:YBMA)  %>%
       droplevels()

lpih<-rarc(lphi, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpih$out
(sd(lpih$bootstrapped.val[[3]][,1]))


```

```{r}
ibo2<-read.csv("./bird_data/intbirds_200m_n20.csv")   # birds detected in 20x300 interior transects

ibo2 %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))
```


**Appendix S2: Figure S2A**

```{r, fig.width =7, fig.height=7 , eval = FALSE, echo=FALSE}
lpi<-read.csv("./bird_data/likepred_SR_INT_bootplot.csv")

FIGboot_likepredINT_samplerich<-
  ggplot(lpi, aes(x=plotsample, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = plotsample, ymin=lo, ymax=hi), 
                width=0,lwd = 0.5, col="black") +
  geom_point(aes(fill=margintype), pch= 21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8])) +
  scale_x_continuous(name = "Orchard-visit samples",limits = c(0,35), expand = c(0, 0), 
                     breaks = c(0,6,12,18,24,30)) +
  scale_y_continuous(name = "Rarefied predator richness", limits = c(0,7), expand = c(0, 0.25)) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_text(size=22, colour="black"), 
        axis.title.y = element_text(size=28, margin = unit(c(0, 5, 0, 0), "mm")),
        axis.ticks.length = unit(3,"mm"),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm")))+
  theme(legend.position="none")

FIGboot_likepredINT_samplerich
```


**Appendix S2: Figure S2B**

```{r, fig.width =7, fig.height=7,eval=FALSE, echo=FALSE}
lpi<-read.csv("./bird_data/likepred_SR_INT_bootplot.csv")

FIGboot_likepredINT_indivrich <-
  ggplot(lpi, aes(x=plotindiv, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = plotindiv, ymin=lo, ymax=hi), 
                width=0,lwd = 0.50, col="black") +
  geom_point(aes(fill=margintype), pch=21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8]),
                    breaks = c("clean","habitat"),
                    labels = c("Clean", "Habitat")) +
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,7), expand = c(0, 0)) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm"))) +
  theme(legend.position=c(0.65, 0.15),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18)) +
  guides(fill = guide_legend(title = "Orchard interior \nwith margin type"))

FIGboot_likepredINT_indivrich                            
```

Combine plots and print
```{r fig.width =14, fig.height=7, warning=FALSE, echo=FALSE , eval=FALSE}
FIG.likepredINT_bootRich_combined<-
  plot_grid(FIGboot_likepredINT_samplerich,FIGboot_likepredINT_indivrich, 
            align='h', axis='b', 
            rel_widths = c(1.10, 1), labels=c('A', 'B'), 
            label_size = 24, 
            label_fontface ="plain",
            label_x = c(0.16,0.09))

FIG.likepredINT_bootRich_combined
```

Export combined plot 
```{r, eval=FALSE, echo=FALSE}
tiff("FIG.likepredINT_bootRich_combined.tif", width=14, height=7, units ='in',res=1000)
FIG.likepredINT_bootRich_combined
dev.off()

cairo_pdf(file = "FIG.likepredINT_bootRich_combined.pdf", width=14, height=7) #embeds fonts
FIG.likepredINT_bootRich_combined
dev.off()
```


**Analyses: Woodpecker maximum abundance models**

Compared poisson, gamma-poisson, and gaussian distribution assumptions and poisson and gamma-poisson were about equal in accuracy.

```{r}
bstan <- read.csv("./bird_data/woodpecker_models.csv") #orhard level data
head(bstan)
```

```{r}
w0 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a,
    a ~ dnorm(0,10)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w0, "w0.rds")
plot(w0) 
```

```{r}
precis(w0, prob = 0.95)
plot(precis(w0, prob = 0.95))
```


```{r}
w1 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w1, "w1.rds")
plot(w1)
```

```{r}
precis(w1, prob = 0.95)
plot(precis(w1, prob = 0.95))
```

```{r}
w2 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1 + bmveg*margvegPC1,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1),
    bmveg ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w2, "w2.rds")
plot(w2)
```

```{r}
precis(w2, prob = 0.95)
plot(precis(w2, prob = 0.95))
```

```{r}
w3 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bsnat*seminat_c,
    a ~ dnorm(0,10),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w3, "w3.rds")
plot(w3)
```

```{r}
precis(w3, prob = 0.95)
plot(precis(w3, prob = 0.95))
```

```{r}
w4 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1 + bsnat*seminat_c,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w4, "w4.rds")
plot(w4)
```

```{r}
precis(w4, prob = 0.95)
plot(precis(w4, prob = 0.95))
```

Let's look at margvegpc1 instead of hab
```{r}
w5 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bmveg*margvegPC1,
    a ~ dnorm(0,10),
    bmveg ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w5, "w5.rds")
plot(w5)
```

```{r}
precis(w5, prob = 0.95)
plot(precis(w5, prob = 0.95))
```

```{r}
w6 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bmveg*margvegPC1 + bsnat*seminat_c,
    a ~ dnorm(0,10),
    bmveg ~ dnorm(0,1),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w6, "w6.rds")
plot(w6)
```

```{r}
precis(w6, prob = 0.95)
plot(precis(w6, prob = 0.95))
```

**Appendix S2:Table S2**

```{r}
I_woodpeckerWAIC<-compare(w0,w1,w2,w3,w4,w5,w6)
I_woodpeckerWAIC
```
So, the model with both treepc1 and seminat_c is the best supported via WAIC. The interaction is second best, and its dWAIC SE doesn't overlap exceed the difference between it and the non-interactive model. These two models have 75% of the model weight.   

**Appendix S2:Table S3**

```{r}
write.table(precis(w4, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w2, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w6, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w5, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w3, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w1, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w0, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
```

Observed vs. predicted
```{r}
# call link without specifying new data
mu <- ensemble(w0,w1,w2,w3,w4,w5,w6)
mu.mean <- apply( mu$link, 2 , mean )
mu.PI <- apply( mu$link , 2 , PI )

plot( mu.mean ~ bstan$wood_maxAb , col=rangi2 , ylim=c(0,12) ,
xlab="Observed woodpeckerMA" , ylab="Predicted woodpeckerMA" )
abline( a=0 , b=1 , lty=2 )
for ( i in 1:nrow(bstan) )
lines( rep(bstan$wood_maxAb[i],2) , c(mu.PI[1,i],mu.PI[2,i]) ,
col=rangi2 )
```

Predictions
```{r}
range(bstan$treepc1) #-0.3574363  0.4840093
range(bstan$seminat_c) #-8.062156 26.256224
range(bstan$margvegPC1) #-0.7726397  1.2953410

tree.seq <- seq( from= -0.4 , to=0.5 , length.out=100 )
seminat.seq <- seq( from= -8.1 , to=26.3 , length.out=100 )
margveg.seq <- seq (from= -0.8 , to=1.3 , length.out=100 )

treepc.pred <- data.frame(
treepc1 = tree.seq,
seminat_c = mean(seminat.seq),
margvegPC1 = mean(margveg.seq)
)

sn.pred <- data.frame(
treepc1 = mean(tree.seq),
seminat_c = seminat.seq,
margvegPC1 = mean(margveg.seq)
)

mv.pred <- data.frame(
treepc1 = mean(tree.seq),
seminat_c = mean(seminat.seq),
margvegPC1 = margveg.seq
)

tree.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=treepc.pred )
tree.mean <- apply( tree.pred$link , 2 , mean )
tree.PI <- apply( tree.pred$link , 2 , PI , prob=0.95)
treepred<-data.frame(tree.mean, tree.PI[1,], tree.PI[2,])
names(treepred)[1:3]<-c("mean.pred","lo","hi")
treepred$tree.seq<-tree.seq


seminat.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=sn.pred )
seminat.mean <- apply( seminat.pred$link , 2 , mean )
seminat.PI <- apply( seminat.pred$link , 2 , PI , prob=0.95)
seminatpred<-data.frame(seminat.mean, seminat.PI[1,], seminat.PI[2,])
names(seminatpred)[1:3]<-c("mean.pred","lo","hi")
seminatpred$seminat.seq<-seminat.seq
seminatpred$seminat.p <-seq( from= 0.077869548, to=37.61956672, length.out=100 )

mveg.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=mv.pred )
mveg.mean <- apply( mveg.pred$link , 2 , mean )
mveg.PI <- apply( mveg.pred$link , 2 , PI, prob=0.95 )
mvegpred<-data.frame(mveg.mean, mveg.PI[1,], mveg.PI[2,])
names(mvegpred)[1:3]<-c("mean.pred","lo","hi")
mvegpred$mveg.seq<-margveg.seq

treepred; seminatpred; mvegpred
```


**Figure 3 : Woodpecker maximum abundance model results**
Using predictions from models reported in paper
```{r}
treewood.pred<-read.csv("./bird_data/tree_wood.pred.csv") 
seminatwood.pred<-read.csv("./bird_data/seminat_wood.pred.csv")
mvegwood.pred<-read.csv("./bird_data/mveg_wood.pred.csv")
bstan <- read.csv("./bird_data/woodpecker_models.csv") 
```

3A. treepc1
```{r, fig.height=6, fig.width=6}
treewoodFIG<-
  ggplot(data=treewood.pred, aes(x=tree.seq, y=mean.pred)) +
  geom_ribbon( aes(ymin=lo, ymax=hi),fill=skhpal[7], alpha=0.5) +
  geom_line( col=skhpal[9], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_continuous(breaks=seq(0,0), labels = paste0(c(" 0 \nPC1"))) +
  geom_point(data=bstan, aes(x=treepc1, y=wood_maxAb), size =3 ) +
   theme(axis.ticks.length = unit(1,"mm"),
        axis.ticks.y = element_line(colour="black"),
        axis.ticks.x = element_line(colour="black"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
        axis.title.x = element_blank(),
        #axis.title.x = element_text(size=28, margin = unit(c(18, 0, 0, 0), "mm")),
        plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
   theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = " ", y=" ", tag = "A") 
treewoodFIG  
```

3B. Seminat
```{r, fig.height=6, fig.width=6}
seminatwoodFIG<-
  ggplot(data=seminatwood.pred, aes(x=seminat.p, y=mean.pred)) +
  geom_ribbon(aes(x=seminat.p, ymin=lo, ymax=hi),fill=skhpal[11], alpha=0.5) +
  geom_line(col=skhpal[10], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  geom_point(data=bstan, aes(x=seminat, y=wood_maxAb), size =3 ) +
  theme_classic() +
  theme(legend.key=element_blank()) +
  theme(axis.ticks.length = unit(1,"mm"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
         axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
         plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = "Seminatural landscape cover (%)", y=" ", tag = "B")

seminatwoodFIG
```

3c. marginveg
```{r, fig.height=6, fig.width=6}
margvegwoodFIG<-
  ggplot(data=mvegwood.pred, aes(x=mveg.seq, y=mean.pred)) +
  geom_ribbon(aes(ymin=lo, ymax=hi),fill=skhpal[4], alpha=0.5) +
  geom_line(col=skhpal[6], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_continuous(breaks=seq(0,0), labels = paste0(c(" 0 \nPC1"))) +
  geom_point(data=bstan, aes(x=margvegPC1, y=wood_maxAb), size =3 ) +
  theme_classic() +
  theme(axis.ticks.length = unit(1,"mm"),
        axis.ticks.y = element_line(colour="black"),
        axis.ticks.x = element_line(colour="black"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
        axis.title.x = element_blank(),
        #axis.title.x = element_text(size=28, margin = unit(c(13, 0, 0, 0), "mm")),
        plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
   theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = " ", y=" ", tag = "C")
margvegwoodFIG
```

Combine
```{r,fig.width=6, fig.height=12, warning=FALSE}
woodpecker.combined.Fig<-plot_grid(treewoodFIG , NULL, seminatwoodFIG, NULL, margvegwoodFIG, NULL, 
            align='v', ncol=1,
            rel_heights = c(1, 0.25, 1, 0.1, 1, 0.10))
woodpecker.combined.Fig
```

Export plot
```{r}
cairo_pdf(file = "Figure3.pdf", width=6, height=12) #embeds fonts
woodpecker.combined.Fig
grid.text("Shorter trees,", x = unit(4, "cm"), y = unit(22.89, "cm" ),gp=gpar(fontsize=20))
grid.text("smaller DBH,", x = unit(4, "cm"), y = unit(22.14, "cm" ),gp=gpar(fontsize=20))
grid.text("shallower fissures", x = unit(4.75, "cm"), y = unit(21.3, "cm" ),gp=gpar(fontsize=20))
grid.text("Taller trees,", x = unit(13, "cm"), y = unit(22.89, "cm"),gp=gpar(fontsize=20))
grid.text("larger DBH,", x = unit(13, "cm"), y = unit(22.14, "cm"),gp=gpar(fontsize=20))
grid.text("deeper fissures", x = unit(12.25, "cm"), y = unit(21.3, "cm"),gp=gpar(fontsize=20))

grid.text("Shorter,", x = unit(3.25, "cm"), y = unit(2.10, "cm" ),gp=gpar(fontsize=20))
grid.text("fewer layers,", x = unit(4, "cm"), y = unit(1.35, "cm" ),gp=gpar(fontsize=20))
grid.text("less patch area", x = unit(4.45, "cm"), y = unit(0.6, "cm" ),gp=gpar(fontsize=20))
grid.text("Taller,", x = unit(14, "cm"), y = unit(2.10, "cm"),gp=gpar(fontsize=20))
grid.text("more layers,", x = unit(13, "cm"), y = unit(1.35, "cm"),gp=gpar(fontsize=20))
grid.text("greater patch area", x = unit(12, "cm"), y = unit(0.6, "cm"),gp=gpar(fontsize=20))

grid.text("Maximum woodpecker abundance (orchard interior)", x = unit(0.5, "cm"), y = unit(16.5, "cm"),
          rot = 90, gp=gpar(fontsize=22))

dev.off()
```

=======
---
title: "Heath, S.K. and R.F. Long. 2019. Multiscale habitat mediates pest reduction by birds in an intensive agricultural region. Ecosphere. DOI: 10.1002/ecs2.2884"
sub-title: "Bird community analyses, tables, and figures"
author: "Sacha K. Heath"
date: "started August 2017; code edited for publication August 2019"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

```{r, include = FALSE}
knitr::opts_chunk$set(comment = NA)
```

Required packages

```{r}
library(plyr)
library(tidyr)
library(dplyr)
library(data.table)
library(reshape)

library(vegan)
library(ape)
library(rethinking)

library(ggplot2)
library(ggrepel)
library(gtable) # for changing the legend letters from a to something else
library(scales)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(grid)
library(cowplot)
```

Colors I like that are also ok for color-blindness
```{r, fig.height=3, fig.width=14}
skhpal<-c("black","gray25","gray75", "slateblue","darkslateblue", "royalblue4", "chartreuse3","forestgreen", "darkgreen","chocolate3","darkgoldenrod1", "darkgoldenrod3", "#fed976","#feb24c","#fd8d3c", "#fc4e2a", "#e31a1c","#b10026")

plot(x = 1:length(skhpal), y = rep(1, length(skhpal)), pch = 19, cex = 5, 
    col = skhpal, yaxt = "n", bty = "n", xaxt = "n", xlab = "", ylab = "")
text(x = 1:length(skhpal), y = rep(1, length(skhpal), labels = seq(1:length(skhpal))))
```


Code presented in order of when it is referred to in the text

**Appendix S2: Table S1**

```{r}
all<-read.csv("./bird_data/all_spp.csv")  # all bird species detected at all distances, margins and interiors
mbo<-read.csv("./bird_data/marginbirds_20m_n20.csv")  # birds detected in 20x300 margin transects
ibo<-read.csv("./bird_data/intbirds_20m_n20.csv")   # birds detected in 20x300 interior transects
ibo2<-read.csv("./bird_data/intbirds_200m_n20.csv") # birds detected in 200x300 interior transects

m<-as.data.frame(names(mbo %>% select(AMCR:PUFI) %>% droplevels())); names(m)[1]<-c("spec")
i<-as.data.frame(names(ibo %>% select(AMCR:YRWA) %>% droplevels())); names(i)[1]<-c("spec")
i2 <-as.data.frame(names(ibo2 %>% select(AMCR:YRWA) %>% droplevels())); names(i2)[1]<-c("spec")
m$m<-1
i$i<-1
i2$i2<-1

transect_speclist<-Reduce(function(x, y) merge(x, y, all=TRUE), list(all, m,i,i2))
transect_speclist
```


**Likely predator categorization by foraging traits**

I used a systematic process to assign diet guilds, foraging site substrates, and attack types for all birds I observed during counts.

Dietary guild  
Foraging Site Substrate  
Attack Behavior  

For non-breeding season/year round dietary guilds, I followed the methodologies of [Kissling et al. (2011)](http://bit.ly/2k1YCjR)
For each species, the dietary components mentioned in the literature were assigned to seven categories. Each category was ranked in importance  for each individual species when it was present as a dietary component *(in winter for this study)*, based on the Birds of North America online species accounts for each species, and/or other sources if necessary. Diet ranks of a species add up to a score of 10, and from this assignment we classified species into dietary guilds based on their primary (i.e. predominant) diet and foraging type (score > 5). This classification characterizes the dominant diet type of a species.All remaining species with diet ranks < 5 (e.g. fruit 5, insect 2, nectar 2, seed 1) were classified as omnivores)

Foreaging substrate definition: the place where a food item is found or taken (DeGraff et al. 1985). To assign non-breeding season/year round Foraging Site Substrate type to our birds, we followed the terminology of [Remsen and Robinson (1990)](http://bit.ly/2xwxvmg) and the classification system of [De Graff et al. 1985](http://bit.ly/2xEF0qI), using BNA as source material as well. 

Attack behavior definition: Foraging technique, refers to the manner in which food is obtained (some associated with particular food types or substrates). To assign non-breeding season/year round Attack Behavior type to our birds, I followed the terminology of [Remsen and Robinson (1990)](http://bit.ly/2xwxvmg) and the classification system of [De Graff et al. 1985](http://bit.ly/2xEF0qI), using BNA as source material as well.

In addition to the above rankings and sources, I further researched for evidence of *C. pomomella* consumption by birds in the literature, as well of evidence outside of [De Graff et al. 1985](http://bit.ly/2xEF0qI) that a species utilizes bark or tree trunks as foraging substrate *while also* using pecking, probing, or flaking attack modes. I researched these criteria for every species detected in our study via liteture searches (sources: Beal 1910, McAtee 1912 {alone and in reference to Melander and Jenne 1906}, Holmes et al. 1979, BNAO, and Ehrlich et al. 1980). We also confirmed species video during the study.

```{r}
lp<-read.csv("./bird_data/likelypredators.csv")    # likely predator species
lp
```



**Figure 2: Absolute maximum abundance heat map of avian predators of C. pomonella in orchard margin and interior strip-transects (20m Ã— 300m). **

```{r}
#Heatmap of relative abundances between sites by [Umer Zeeshan Ijaz] [http://userweb.eng.gla.ac.uk/umer.ijaz]

df<-read.csv("./bird_data/abs_abundance_heatmap.csv") #Maximum abundance (across 3 visits) of likely predators
df$site<-as.factor(df$site)
```

```{r, fig.width=6, fig.height=7, warning =FALSE}
lpred_MA_heatmap<-
  ggplot(df, aes(site, Species)) + 
  geom_tile(aes(fill = MA), col = "white") + #this color outlines the tiles
  scale_fill_gradientn(name="                       ", 
                       colours=c("white",      "#fed976", "#fed976",     "#fd8d3c","#fd8d3c",  #colorblind friendly
                                 "#fc4e2a","#fc4e2a","#fc4e2a",        "#b10026"), 
                       values=rescale(c(0,      1,                       2, 3, 
                                 4, 5, 6,                                13)),
                       breaks=c(0,1.25,3,6,13),labels=c(0,"1","2-3","4-6","13"),limits=c(0,13)) + 
  scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) +
  #coord_fixed(ratio=1) +
  facet_wrap(~trantype , ncol = 1, scales = "free", switch="x") +
  theme_classic() +
  theme(axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size=14, color = "black"),
        strip.background = element_blank(), strip.text = element_text(size = 20), 
        strip.placement = "outside",
        panel.spacing = unit(0.5, "cm"),
        legend.position = "top", 
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        legend.key.width = unit(1, "cm"),legend.key.height = unit(0.50, "cm"),
        plot.margin=unit(c(0.5,0.5,0.5,0.5),"mm"))

lpred_MA_heatmap
```


```{r}
tiff("Figure2.tiff", width = 6, height = 6, units = 'in',res=600)
lpred_MA_heatmap
grid.text("Maximum abundance", x = unit(6.5, "cm"), y = unit(14.75, "cm"), gp=gpar(fontsize=18))
dev.off()

cairo_pdf(file = "Figure2.pdf", width=6, height=6) #embeds fonts
lpred_MA_heatmap
grid.text("Maximum abundance", x = unit(6.5, "cm"), y = unit(14.75, "cm"), gp=gpar(fontsize=18))
dev.off()
```

Maximum abundance summaries
```{r}
mbo<-read.csv("./bird_data/marginbirds_20m_n20.csv")  # birds detected in 20x300 margin transects

mbo %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))

ibo<-read.csv("./bird_data/intbirds_20m_n20.csv")   # birds detected in 20x300 interior transects
ibo %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))
```

**Analyses: Rarefied Richness and Abundance; 20m x 300m margin transects**

```{r}
mbv <-read.csv("./bird_data/marginbirds_20m_n60.csv")  #20 x 300m margin detections by orchards and visits, n = 60
lp<-read.csv("./bird_data/likelypredators.csv")  

Reduce(intersect, list(names(mbv),lp$spec)) #which likely predators are in the margin database?

lpmv<-mbv %>%
  dplyr::select(orchard, edgegen, visit, NOFL, YBMA, BEWR, BUSH, NUWO, RBSA, ACWO, HETH, OATI, WBNU) #likely predator species only

#likeley predators in clean margins
lpcm<- lpmv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="control") %>%
       ungroup() %>%
       dplyr::select(NOFL:WBNU)  %>%
       droplevels()

# Compute individual- and sample- based rarefaction curve via boostrap. rarc() performs rarefaction using resampling with replacement.
# Bootstrap estimation based on 999 randomizations
lpmc<-rarc(lpcm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmc$out #curve estimates
rarc_lpcm<-as.data.frame(lpmc$out) #curve estimates
lpmc$bootstrapped.val #raw bootstrapped values
(sd(lpmc$bootstrapped.val[[3]][,1])) #Compute the standard deviation, instead of the quantiles, for the final (10th) sampling


#likeley predators habitat margins
lphm<- lpmv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="habitat") %>%
       ungroup() %>%
       dplyr::select(NOFL:WBNU)  %>%
       droplevels()

lpmh<-rarc(lphm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmh$out
rarc_lphm<-as.data.frame(lpmh$out)
lpmh$bootstrapped.val
(sd(lpmh$bootstrapped.val[[3]][,1]))
```

**Appendix S2: Figure S1 A**

```{r, fig.width =7, fig.height=7 , eval=FALSE, echo=FALSE}
lpp<-read.csv("./bird_data/likepred_SR_MARG_bootplot.csv")

FIGboot_likepred_samplerich<-
  ggplot(lpp, aes(x=sample, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = sample, ymin=lo, ymax=hi), width=0,lwd = 0.5, col="black") +
  geom_point(aes(fill=margintype), pch= 21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8])) +
  scale_x_continuous(name = "Orchard-visit samples",limits = c(0,35), expand = c(0, 0), 
                    breaks = c(0,6,12,18,24,30)) +
  scale_y_continuous(name = "Rarefied predator richness", limits = c(0,11), expand = c(0, 0.25)) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_text(size=22, colour="black"), 
        axis.title.y = element_text(size=28, margin = unit(c(0, 5, 0, 0), "mm")),
        axis.ticks.length = unit(3,"mm"),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm")))+
  theme(legend.position="none")
FIGboot_likepred_samplerich 
```


**Appendix S2: Figure S1 B**

```{r, fig.width =7, fig.height=7,warnign=FALSE}
lpp<-read.csv("./bird_data/likepred_SR_MARG_bootplot.csv")
lpp_habitat<-filter(lpp, margintype=="habitat")
lpp_clean<-filter(lpp, margintype=="clean")

#To help plot the low number of detections in clean margins
p <-
  ggplot(NULL, aes(x=0:95, y=0,11)) +
  geom_line(data = lpp_habitat, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_line(data = lpp_clean, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_errorbar(data = lpp_habitat, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="black") +
  geom_errorbar(data = lpp_clean, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="gray40") + 
  geom_point(data = lpp_habitat, aes(x=indiv, y=cum.rich), size=7, shape=21, fill=skhpal[8]) +
  geom_point(data = lpp_clean, aes(x=indiv, y=cum.rich), size=2, shape=21, fill=skhpal[10]) + 
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,11), expand = c(0, 0.25)) 

# Got this hack from [here][https://stackoverflow.com/questions/16389636/in-ggplot2-how-can-i-add-additional-legend]
a= 94
b= rep(c(20), 20)
f = 1:20 
factor=c("Clean","Habitat")
abf = data.frame(a,b,f, factor)

FIGboot_likepred_indivrich <-
  ggplot(NULL, aes(x=0:95, y=0,11)) +
  geom_line(data = lpp_habitat, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_line(data = lpp_clean, aes(x=indiv, y=cum.rich), lwd=1, colour="black") +
  geom_errorbar(data = lpp_habitat, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="black") +
  geom_errorbar(data = lpp_clean, aes(x = indiv, ymin=lo, ymax=hi), width=0, lwd = 0.5, col="gray40") + 
  geom_point(data = lpp_habitat, aes(x=indiv, y=cum.rich), size=7, shape=21, fill=skhpal[8]) +
  geom_point(data = lpp_clean, aes(x=indiv, y=cum.rich), size=2, shape=21, fill=skhpal[10]) + 
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,11), expand = c(0, 0.25))  +
  geom_point(data = abf, aes(x=a, y=f,fill=factor), color="white") + # hack
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm"))) +
  theme(legend.position=c(0.80, 0.20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18)) +
  guides(fill = guide_legend(title = "Margin type",
                            override.aes = list(shape=21, size = 8, color="black",
                            fill = c(skhpal[10],skhpal[8]))))
FIGboot_likepred_indivrich
```

Combine plots and print
```{r, fig.width =14, fig.height=7, warning=FALSE, echo=FALSE, eval=FALSE}
FIG.likepred_bootRich_combined<-
  plot_grid(FIGboot_likepred_samplerich,FIGboot_likepred_indivrich, 
            align='h', axis='b', 
            rel_widths = c(1.10, 1), 
            labels=c('A', 'B'), label_size = 24, label_fontface ="plain", label_x = c(0.16,0.09))

FIG.likepred_bootRich_combined 
```

Export combined plot 
```{r export FIG.likepred_bootRich_combined, echo=FALSE, eval=FALSE}
tiff("FIG.likepred_bootRich_combined.tif", width=14, height=7, units ='in',res=1000)
FIG.likepred_bootRich_combined
dev.off()

cairo_pdf(file = "FIG.likepred_bootRich_combined.pdf", width=14, height=7) #embeds fonts
FIG.likepred_bootRich_combined
dev.off()
```


**Analyses: Bray-Curtis Dissimilarity Index for 20m x 300m margin and interior transects**

```{r}
lpreds <- read.csv("./bird_data/lpred.matrix.csv") # Likely predators maximum abundance for 20m x 300m margin and interior transects
lpred.matrix <- as.matrix(sapply(lpreds[2:11], as.numeric))
rownames(lpred.matrix)<-(lpreds)[,1]
lpred_M.diss.I_bray<-vegdist(lpred.matrix, method = "bray")
lpred_M.diss.I_bray
```



**Analyses: NMDS and Permutational Multivariate Analysis of Variance Using Distance Matrices, for 20m x 300m margin and interior transects**

```{r}
lpreds <- read.csv("./bird_data/lpred.matrix.csv") # Likely predators maximum abundance for 20m x 300m margin and interior transects
lpred.matrix <- as.matrix(sapply(lpreds[2:11], as.numeric))
rownames(lpred.matrix)<-(lpreds)[,1]


lp_NMDS = metaMDS(lpred.matrix,          # community matrix
                  distance = "bray", # type of dissimilarity to calculate
                  k = 2,             # reduce to 2 dimensions
                  #trymax = 100,      # max number of random starts (increase if no stable converge)
                  #noshare	= 0.1,     # Prop. site pairs with no shared species to trigger stepacross 
                  wascores = TRUE)   #	Calculate weighted average species scores 
                     
lpreds.sq <- sqrt(lpred.matrix)
lp.sq_NMDS = metaMDS(lpreds.sq,          # community matrix
                  distance = "bray", # type of dissimilarity to calculate
                  k = 2,             # reduce to 2 dimensions
                  #trymax = 100,      # max number of random starts (increase if no stable converge)
                  #noshare	= 0.1,     # Prop. site pairs with no shared species to trigger stepacross 
                  wascores = TRUE)   #	Calculate weight


lp_NMDS; lp.sq_NMDS

lp_NMDS$stress
stressplot(lp_NMDS)
stressplot(lp.sq_NMDS)
plot(lp_NMDS)
plot(lp.sq_NMDS)

####

lpsite <- read.csv("./bird_data/lpred.site.data.matrix.csv")
lp.site_data <- as.matrix(sapply(lpsite[2:7], as.numeric))
rownames(lp.site_data)<-(lpsite)[,1]

trantype<-as.factor(lp.site_data[,2])
pair<-as.factor(lp.site_data[,5])
margtype<-as.factor(lp.site_data[,3])
orchard<-as.factor(lp.site_data[,1])

multi.anova<-adonis(lpred.matrix ~ trantype + margtype + trantype*margtype, strata=orchard, perm=999)
multi.anova
```


**Analyses: Rarefied Richness; 200m x 300m interior transects**

```{r}
ibv <-read.csv("./bird_data/intbirds_200m_n60.csv")  # 200m x 300m interior birds by orchards and visits
lp<-read.csv("./bird_data/likelypredators.csv")  

Reduce(intersect, list(names(ibv),lp$spec)) #which likely predators are in the interior database?

lpiv<-ibv %>%
  dplyr::select(orchard, edgegen, visit, HETH, NOFL, NUWO, OATI, WBNU, YBMA) 

# likely predators in orchard interiors with clean margins
lpci<- lpiv %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="control") %>%
       ungroup() %>%
       dplyr::select(HETH:YBMA)  %>%
       droplevels()

# Compute individual- and sample- based rarefaction curve via boostrap. rarc() performs rarefaction using resampling with replacement.
# Bootstrap estimation based on 999 randomizations
lpic<-rarc(lpci, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpic$out #curve estimates
lpic$bootstrapped.val #raw bootstrapped values
(sd(lpic$bootstrapped.val[[3]][,1]))

lpmc<-rarc(lpcm, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpmc$out #curve estimates
lpmc$bootstrapped.val #raw bootstrapped values
(sd(lpmc$bootstrapped.val[[3]][,1])) #Compute the standard deviation, instead of the quantiles, for the final (10th) sampling


# likely predators in orchard interiors with habitat margins
lphi<- lpiv  %>%
       group_by(orchard, visit, edgegen) %>%
       filter(edgegen=="habitat") %>%
       ungroup() %>%
       dplyr::select(HETH:YBMA)  %>%
       droplevels()

lpih<-rarc(lphi, samplesize=c(3,6,9,12,15,18,21,24,27,30), nrandom=999, p1=0.975,p2=0.025, save=TRUE)
lpih$out
(sd(lpih$bootstrapped.val[[3]][,1]))


```

```{r}
ibo2<-read.csv("./bird_data/intbirds_200m_n20.csv")   # birds detected in 20x300 interior transects

ibo2 %>% group_by(edgegen) %>%
  summarize(meanmaxab = mean(lpred_maxAb),
            sdmaxab = sd(lpred_maxAb))
```


**Appendix S2: Figure S2A**

```{r, fig.width =7, fig.height=7 , eval = FALSE, echo=FALSE}
lpi<-read.csv("./bird_data/likepred_SR_INT_bootplot.csv")

FIGboot_likepredINT_samplerich<-
  ggplot(lpi, aes(x=plotsample, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = plotsample, ymin=lo, ymax=hi), 
                width=0,lwd = 0.5, col="black") +
  geom_point(aes(fill=margintype), pch= 21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8])) +
  scale_x_continuous(name = "Orchard-visit samples",limits = c(0,35), expand = c(0, 0), 
                     breaks = c(0,6,12,18,24,30)) +
  scale_y_continuous(name = "Rarefied predator richness", limits = c(0,7), expand = c(0, 0.25)) +
  theme_classic() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_text(size=22, colour="black"), 
        axis.title.y = element_text(size=28, margin = unit(c(0, 5, 0, 0), "mm")),
        axis.ticks.length = unit(3,"mm"),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm")))+
  theme(legend.position="none")

FIGboot_likepredINT_samplerich
```


**Appendix S2: Figure S2B**

```{r, fig.width =7, fig.height=7,eval=FALSE, echo=FALSE}
lpi<-read.csv("./bird_data/likepred_SR_INT_bootplot.csv")

FIGboot_likepredINT_indivrich <-
  ggplot(lpi, aes(x=plotindiv, y=cum.rich, group=margintype)) +
  geom_line(lwd=1, colour="black") +
  geom_errorbar(aes(x = plotindiv, ymin=lo, ymax=hi), 
                width=0,lwd = 0.50, col="black") +
  geom_point(aes(fill=margintype), pch=21, size=7) +
  scale_fill_manual(values=c(skhpal[10],skhpal[8]),
                    breaks = c("clean","habitat"),
                    labels = c("Clean", "Habitat")) +
  scale_x_continuous(name = "Bird detections",limits = c(0,95), expand = c(0, 0) ) +
  scale_y_continuous(limits = c(0,7), expand = c(0, 0)) +
  theme(panel.grid = element_blank(),
        panel.border = element_blank()) +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=22, colour="black"),
        axis.title.x = element_text(size=28, margin = unit(c(5, 0, 0, 0), "mm"))) +
  theme(legend.position=c(0.65, 0.15),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18)) +
  guides(fill = guide_legend(title = "Orchard interior \nwith margin type"))

FIGboot_likepredINT_indivrich                            
```

Combine plots and print
```{r fig.width =14, fig.height=7, warning=FALSE, echo=FALSE , eval=FALSE}
FIG.likepredINT_bootRich_combined<-
  plot_grid(FIGboot_likepredINT_samplerich,FIGboot_likepredINT_indivrich, 
            align='h', axis='b', 
            rel_widths = c(1.10, 1), labels=c('A', 'B'), 
            label_size = 24, 
            label_fontface ="plain",
            label_x = c(0.16,0.09))

FIG.likepredINT_bootRich_combined
```

Export combined plot 
```{r, eval=FALSE, echo=FALSE}
tiff("FIG.likepredINT_bootRich_combined.tif", width=14, height=7, units ='in',res=1000)
FIG.likepredINT_bootRich_combined
dev.off()

cairo_pdf(file = "FIG.likepredINT_bootRich_combined.pdf", width=14, height=7) #embeds fonts
FIG.likepredINT_bootRich_combined
dev.off()
```


**Analyses: Woodpecker maximum abundance models**

Compared poisson, gamma-poisson, and gaussian distribution assumptions and poisson and gamma-poisson were about equal in accuracy.

```{r}
bstan <- read.csv("./bird_data/woodpecker_models.csv") #orhard level data
head(bstan)
```

```{r}
w0 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a,
    a ~ dnorm(0,10)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w0, "w0.rds")
plot(w0) 
```

```{r}
precis(w0, prob = 0.95)
plot(precis(w0, prob = 0.95))
```


```{r}
w1 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w1, "w1.rds")
plot(w1)
```

```{r}
precis(w1, prob = 0.95)
plot(precis(w1, prob = 0.95))
```

```{r}
w2 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1 + bmveg*margvegPC1,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1),
    bmveg ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w2, "w2.rds")
plot(w2)
```

```{r}
precis(w2, prob = 0.95)
plot(precis(w2, prob = 0.95))
```

```{r}
w3 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bsnat*seminat_c,
    a ~ dnorm(0,10),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w3, "w3.rds")
plot(w3)
```

```{r}
precis(w3, prob = 0.95)
plot(precis(w3, prob = 0.95))
```

```{r}
w4 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + btpc*treepc1 + bsnat*seminat_c,
    a ~ dnorm(0,10),
    btpc ~ dnorm(0,1),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w4, "w4.rds")
plot(w4)
```

```{r}
precis(w4, prob = 0.95)
plot(precis(w4, prob = 0.95))
```

Let's look at margvegpc1 instead of hab
```{r}
w5 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bmveg*margvegPC1,
    a ~ dnorm(0,10),
    bmveg ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w5, "w5.rds")
plot(w5)
```

```{r}
precis(w5, prob = 0.95)
plot(precis(w5, prob = 0.95))
```

```{r}
w6 <- map2stan(
  alist(
    wood_maxAb ~ dpois(mu),
    log(mu) <- a + bmveg*margvegPC1 + bsnat*seminat_c,
    a ~ dnorm(0,10),
    bmveg ~ dnorm(0,1),
    bsnat ~ dnorm(0,1)
  ),
  data=bstan ,
  warmup = 1000, iter = 4000, chains=3, cores=4)

#saveRDS(w6, "w6.rds")
plot(w6)
```

```{r}
precis(w6, prob = 0.95)
plot(precis(w6, prob = 0.95))
```

**Appendix S2:Table S2**

```{r}
I_woodpeckerWAIC<-compare(w0,w1,w2,w3,w4,w5,w6)
I_woodpeckerWAIC
```
So, the model with both treepc1 and seminat_c is the best supported via WAIC. The interaction is second best, and its dWAIC SE doesn't overlap exceed the difference between it and the non-interactive model. These two models have 75% of the model weight.   

**Appendix S2:Table S3**

```{r}
write.table(precis(w4, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w2, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w6, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w5, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w3, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w1, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
write.table(precis(w0, prob=0.95)@output, "clipboard", sep="\t", row.names=TRUE)
```

Observed vs. predicted
```{r}
# call link without specifying new data
mu <- ensemble(w0,w1,w2,w3,w4,w5,w6)
mu.mean <- apply( mu$link, 2 , mean )
mu.PI <- apply( mu$link , 2 , PI )

plot( mu.mean ~ bstan$wood_maxAb , col=rangi2 , ylim=c(0,12) ,
xlab="Observed woodpeckerMA" , ylab="Predicted woodpeckerMA" )
abline( a=0 , b=1 , lty=2 )
for ( i in 1:nrow(bstan) )
lines( rep(bstan$wood_maxAb[i],2) , c(mu.PI[1,i],mu.PI[2,i]) ,
col=rangi2 )
```

Predictions
```{r}
range(bstan$treepc1) #-0.3574363  0.4840093
range(bstan$seminat_c) #-8.062156 26.256224
range(bstan$margvegPC1) #-0.7726397  1.2953410

tree.seq <- seq( from= -0.4 , to=0.5 , length.out=100 )
seminat.seq <- seq( from= -8.1 , to=26.3 , length.out=100 )
margveg.seq <- seq (from= -0.8 , to=1.3 , length.out=100 )

treepc.pred <- data.frame(
treepc1 = tree.seq,
seminat_c = mean(seminat.seq),
margvegPC1 = mean(margveg.seq)
)

sn.pred <- data.frame(
treepc1 = mean(tree.seq),
seminat_c = seminat.seq,
margvegPC1 = mean(margveg.seq)
)

mv.pred <- data.frame(
treepc1 = mean(tree.seq),
seminat_c = mean(seminat.seq),
margvegPC1 = margveg.seq
)

tree.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=treepc.pred )
tree.mean <- apply( tree.pred$link , 2 , mean )
tree.PI <- apply( tree.pred$link , 2 , PI , prob=0.95)
treepred<-data.frame(tree.mean, tree.PI[1,], tree.PI[2,])
names(treepred)[1:3]<-c("mean.pred","lo","hi")
treepred$tree.seq<-tree.seq


seminat.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=sn.pred )
seminat.mean <- apply( seminat.pred$link , 2 , mean )
seminat.PI <- apply( seminat.pred$link , 2 , PI , prob=0.95)
seminatpred<-data.frame(seminat.mean, seminat.PI[1,], seminat.PI[2,])
names(seminatpred)[1:3]<-c("mean.pred","lo","hi")
seminatpred$seminat.seq<-seminat.seq
seminatpred$seminat.p <-seq( from= 0.077869548, to=37.61956672, length.out=100 )

mveg.pred <- ensemble(w0,w1,w2,w3,w4,w5,w6, data=mv.pred )
mveg.mean <- apply( mveg.pred$link , 2 , mean )
mveg.PI <- apply( mveg.pred$link , 2 , PI, prob=0.95 )
mvegpred<-data.frame(mveg.mean, mveg.PI[1,], mveg.PI[2,])
names(mvegpred)[1:3]<-c("mean.pred","lo","hi")
mvegpred$mveg.seq<-margveg.seq

treepred; seminatpred; mvegpred
```


**Figure 3 : Woodpecker maximum abundance model results**
Using predictions from models reported in paper
```{r}
treewood.pred<-read.csv("./bird_data/tree_wood.pred.csv") 
seminatwood.pred<-read.csv("./bird_data/seminat_wood.pred.csv")
mvegwood.pred<-read.csv("./bird_data/mveg_wood.pred.csv")
bstan <- read.csv("./bird_data/woodpecker_models.csv") 
```

3A. treepc1
```{r, fig.height=6, fig.width=6}
treewoodFIG<-
  ggplot(data=treewood.pred, aes(x=tree.seq, y=mean.pred)) +
  geom_ribbon( aes(ymin=lo, ymax=hi),fill=skhpal[7], alpha=0.5) +
  geom_line( col=skhpal[9], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_continuous(breaks=seq(0,0), labels = paste0(c(" 0 \nPC1"))) +
  geom_point(data=bstan, aes(x=treepc1, y=wood_maxAb), size =3 ) +
   theme(axis.ticks.length = unit(1,"mm"),
        axis.ticks.y = element_line(colour="black"),
        axis.ticks.x = element_line(colour="black"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
        axis.title.x = element_blank(),
        #axis.title.x = element_text(size=28, margin = unit(c(18, 0, 0, 0), "mm")),
        plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
   theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = " ", y=" ", tag = "A") 
treewoodFIG  
```

3B. Seminat
```{r, fig.height=6, fig.width=6}
seminatwoodFIG<-
  ggplot(data=seminatwood.pred, aes(x=seminat.p, y=mean.pred)) +
  geom_ribbon(aes(x=seminat.p, ymin=lo, ymax=hi),fill=skhpal[11], alpha=0.5) +
  geom_line(col=skhpal[10], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  geom_point(data=bstan, aes(x=seminat, y=wood_maxAb), size =3 ) +
  theme_classic() +
  theme(legend.key=element_blank()) +
  theme(axis.ticks.length = unit(1,"mm"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
         axis.title.x = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
         plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = "Seminatural landscape cover (%)", y=" ", tag = "B")

seminatwoodFIG
```

3c. marginveg
```{r, fig.height=6, fig.width=6}
margvegwoodFIG<-
  ggplot(data=mvegwood.pred, aes(x=mveg.seq, y=mean.pred)) +
  geom_ribbon(aes(ymin=lo, ymax=hi),fill=skhpal[4], alpha=0.5) +
  geom_line(col=skhpal[6], lwd=2) +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_continuous(breaks=seq(0,0), labels = paste0(c(" 0 \nPC1"))) +
  geom_point(data=bstan, aes(x=margvegPC1, y=wood_maxAb), size =3 ) +
  theme_classic() +
  theme(axis.ticks.length = unit(1,"mm"),
        axis.ticks.y = element_line(colour="black"),
        axis.ticks.x = element_line(colour="black"),
        axis.text.y = element_text(size=18, colour="black"), 
        axis.title.y = element_text(size=20),
        axis.text.x = element_text(size=18, colour="black"),
        axis.title.x = element_blank(),
        #axis.title.x = element_text(size=28, margin = unit(c(13, 0, 0, 0), "mm")),
        plot.tag.position = c(0.18, 0.97),
        plot.tag = element_text(size=20)) +
   theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),"cm")) +
  labs(x = " ", y=" ", tag = "C")
margvegwoodFIG
```

Combine
```{r,fig.width=6, fig.height=12, warning=FALSE}
woodpecker.combined.Fig<-plot_grid(treewoodFIG , NULL, seminatwoodFIG, NULL, margvegwoodFIG, NULL, 
            align='v', ncol=1,
            rel_heights = c(1, 0.25, 1, 0.1, 1, 0.10))
woodpecker.combined.Fig
```

Export plot
```{r}
cairo_pdf(file = "Figure3.pdf", width=6, height=12) #embeds fonts
woodpecker.combined.Fig
grid.text("Shorter trees,", x = unit(4, "cm"), y = unit(22.89, "cm" ),gp=gpar(fontsize=20))
grid.text("smaller DBH,", x = unit(4, "cm"), y = unit(22.14, "cm" ),gp=gpar(fontsize=20))
grid.text("shallower fissures", x = unit(4.75, "cm"), y = unit(21.3, "cm" ),gp=gpar(fontsize=20))
grid.text("Taller trees,", x = unit(13, "cm"), y = unit(22.89, "cm"),gp=gpar(fontsize=20))
grid.text("larger DBH,", x = unit(13, "cm"), y = unit(22.14, "cm"),gp=gpar(fontsize=20))
grid.text("deeper fissures", x = unit(12.25, "cm"), y = unit(21.3, "cm"),gp=gpar(fontsize=20))

grid.text("Shorter,", x = unit(3.25, "cm"), y = unit(2.10, "cm" ),gp=gpar(fontsize=20))
grid.text("fewer layers,", x = unit(4, "cm"), y = unit(1.35, "cm" ),gp=gpar(fontsize=20))
grid.text("less patch area", x = unit(4.45, "cm"), y = unit(0.6, "cm" ),gp=gpar(fontsize=20))
grid.text("Taller,", x = unit(14, "cm"), y = unit(2.10, "cm"),gp=gpar(fontsize=20))
grid.text("more layers,", x = unit(13, "cm"), y = unit(1.35, "cm"),gp=gpar(fontsize=20))
grid.text("greater patch area", x = unit(12, "cm"), y = unit(0.6, "cm"),gp=gpar(fontsize=20))

grid.text("Maximum woodpecker abundance (orchard interior)", x = unit(0.5, "cm"), y = unit(16.5, "cm"),
          rot = 90, gp=gpar(fontsize=22))

dev.off()
```

>>>>>>> 1c5673e73a321d2569c476a141c5e16ec7066860
Converted to .tiff via pdf.